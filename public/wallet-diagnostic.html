<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Detection Diagnostic - ZKswap</title>
    <script src="https://unpkg.com/@solana/wallet-adapter-base@0.9.27/lib/index.iife.js"></script>
    <script src="https://unpkg.com/@solana/wallet-adapter-wallets@0.19.37/lib/index.iife.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .test-box { 
            background: white; 
            padding: 20px; 
            margin: 10px 0; 
            border-radius: 8px;
            border-left: 4px solid #6366F1;
        }
        .success { border-left-color: #10B981; }
        .error { border-left-color: #EF4444; }
        .warning { border-left-color: #F59E0B; }
        .info { border-left-color: #3B82F6; }
        .wallet-status { 
            font-size: 16px; 
            font-weight: bold; 
            padding: 10px; 
            border-radius: 4px; 
            margin: 10px 0;
            text-align: center;
        }
        .connected { background: #ECFDF5; color: #065F46; }
        .disconnected { background: #FEF3C7; color: #92400E; }
        .not-detected { background: #FEE2E2; color: #991B1B; }
        button { 
            background: #6366F1; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #4F46E5; }
        button:disabled { background: #9CA3AF; cursor: not-allowed; }
    </style>
</head>
<body>
    <h1>üîç ZKswap Wallet Detection Diagnostic</h1>
    
    <div id="results"></div>
    
    <div style="text-align: center; margin: 20px 0;">
        <button id="testPhantom">Test Phantom Wallet</button>
        <button id="testSolflare">Test Solflare Wallet</button>
        <button id="testMathWallet">Test MathWallet</button>
        <button id="runFullTest">Run Full Diagnostic</button>
    </div>

    <script>
        // Mock wallet adapters untuk testing
        const mockAdapters = {
            phantom: {
                name: 'Phantom',
                icon: 'https://phantom.app/img/phantom-icon.png',
                url: 'https://phantom.app',
                detect: () => typeof window !== 'undefined' && window.solana && window.solana.isPhantom,
                connect: async () => {
                    if (!window.solana) throw new Error('Phantom wallet not found');
                    if (!window.solana.isConnected) {
                        const response = await window.solana.connect();
                        return response.publicKey.toString();
                    }
                    return window.solana.publicKey.toString();
                },
                getAddress: () => window.solana?.publicKey?.toString() || null
            },
            solflare: {
                name: 'Solflare',
                icon: 'https://solflare.com/imgs/logos/logo-white.svg',
                url: 'https://solflare.com',
                detect: () => typeof window !== 'undefined' && window.solflare,
                connect: async () => {
                    if (!window.solflare) throw new Error('Solflare wallet not found');
                    if (!window.solflare.connected) {
                        await window.solflare.connect();
                    }
                    return window.solflare.publicKey.toString();
                },
                getAddress: () => window.solflare?.publicKey?.toString() || null
            },
            mathwallet: {
                name: 'MathWallet',
                icon: 'https://mathwallet.org/images/logo.png',
                url: 'https://mathwallet.org',
                detect: () => typeof window !== 'undefined' && window.solana && window.solana.isMathWallet,
                connect: async () => {
                    if (!window.solana) throw new Error('MathWallet not found');
                    if (!window.solana.isConnected) {
                        const response = await window.solana.connect();
                        return response.publicKey.toString();
                    }
                    return window.solana.publicKey.toString();
                },
                getAddress: () => window.solana?.publicKey?.toString() || null
            }
        };

        const results = document.getElementById('results');

        async function addResult(title, content, type = 'info') {
            const div = document.createElement('div');
            div.className = `test-box ${type}`;
            div.innerHTML = `<h3>${title}</h3><p>${content}</p>`;
            results.appendChild(div);
        }

        function updateWalletStatus(status, address = null) {
            const statusDiv = document.getElementById('walletStatus') || document.createElement('div');
            statusDiv.id = 'walletStatus';
            statusDiv.className = `wallet-status ${status}`;
            statusDiv.innerHTML = `
                <strong>WALLET STATUS: ${status.toUpperCase()}</strong><br>
                ${address ? `Address: ${address}` : 'No wallet detected'}
            `;
            results.insertBefore(statusDiv, results.firstChild);
        }

        async function testWalletAdapter(adapter) {
            const detection = adapter.detect();
            let address = null;
            
            await addResult(`${adapter.name} Detection`, 
                `Detected: ${detection ? '‚úÖ YES' : '‚ùå NO'}\nURL: ${adapter.url}`, 
                detection ? 'success' : 'error');

            if (detection) {
                try {
                    address = adapter.getAddress();
                    await addResult(`${adapter.name} Address`, 
                        `Current Address: ${address || 'None'}\nStatus: ${address ? 'Connected' : 'Not Connected'}`, 
                        address ? 'success' : 'warning');
                    return { adapter, detected: true, address };
                } catch (error) {
                    await addResult(`${adapter.name} Error`, 
                        `Error getting address: ${error.message}`, 'error');
                }
            }
            
            return { adapter, detected: false, address: null };
        }

        async function runFullDiagnostic() {
            results.innerHTML = '';
            await addResult('üîß Diagnostic Started', 'Running full wallet detection test...', 'info');
            
            // Test browser support
            await addResult('üåê Browser Support', 
                `User Agent: ${navigator.userAgent.substring(0, 100)}...\nHTTPS: ${location.protocol === 'https:' ? '‚úÖ' : '‚ùå (REQUIRED)'}`, 
                location.protocol === 'https:' ? 'success' : 'error');

            // Test window object
            await addResult('ü™ü Window Object', 
                `Window Object: ${typeof window !== 'undefined' ? '‚úÖ Available' : '‚ùå Missing'}\nConsole: ${typeof console !== 'undefined' ? '‚úÖ Available' : '‚ùå Missing'}`, 
                'success');

            // Test Solana objects
            await addResult('‚õìÔ∏è Solana Objects', 
                `window.solana: ${typeof window.solana !== 'undefined' ? '‚úÖ Available' : '‚ùå Not Available'}\nwindow.solflare: ${typeof window.solflare !== 'undefined' ? '‚úÖ Available' : '‚ùå Not Available'}`, 
                (typeof window.solana !== 'undefined' || typeof window.solflare !== 'undefined') ? 'success' : 'warning');

            // Test wallet adapters
            let detectedWallets = [];
            for (const [key, adapter] of Object.entries(mockAdapters)) {
                const result = await testWalletAdapter(adapter);
                if (result.detected && result.address) {
                    detectedWallets.push(result);
                }
            }

            // Update overall status
            if (detectedWallets.length > 0) {
                const wallet = detectedWallets[0];
                updateWalletStatus('connected', wallet.address);
                await addResult('üéØ RESULT: Wallet Connected', 
                    `Detected and connected: ${wallet.adapter.name}\nAddress: ${wallet.address}`, 'success');
            } else {
                updateWalletStatus('not-detected');
                await addResult('‚ùå RESULT: No Wallet Detected', 
                    'No supported wallets found. Please install a wallet extension.', 'error');
            }

            // Instructions
            await addResult('üí° Instructions', 
                detectedWallets.length > 0 ? 
                '‚úÖ Your wallet is working! Try connecting to ZKswap.' :
                '1. Install Phantom, Solflare, or MathWallet browser extension\n2. Refresh this page\n3. Click "Connect Wallet" in ZKswap', 
                detectedWallets.length > 0 ? 'success' : 'warning');
        }

        // Add event listeners
        document.getElementById('testPhantom').addEventListener('click', () => testWalletAdapter(mockAdapters.phantom));
        document.getElementById('testSolflare').addEventListener('click', () => testWalletAdapter(mockAdapters.solflare));
        document.getElementById('testMathWallet').addEventListener('click', () => testWalletAdapter(mockAdapters.mathwallet));
        document.getElementById('runFullTest').addEventListener('click', runFullDiagnostic);

        // Auto-run diagnostic
        runFullDiagnostic();
    </script>
</body>
</html>